package main

import (
	"fmt"
	"os"

	"github.com/sirupsen/logrus"
	"github.com/urfave/cli/v2"

	"github.com/ppxl/harbor-cve-finder/cmd"
	"github.com/ppxl/harbor-cve-finder/logging"
)

const flagLogLevel = "log-level"

// the go compiler sets these values, these don't need to be public
var (
	version   string
	goVersion string
)

var (
	log           = logging.GetInstance()
	osExit anExit = &realOsExit{}
)

func configureLogging(cliCtx *cli.Context) error {
	logLevelStr := cliCtx.String(flagLogLevel)
	logLevel, err := logrus.ParseLevel(logLevelStr)
	if err != nil {
		return fmt.Errorf("failed to parse log level %s: %w", logLevelStr, err)
	}
	err = logging.Init(logLevel)
	if err != nil {
		return fmt.Errorf("failed to initialize logger: %w", err)
	}
	return nil
}

func main() {
	app := cli.NewApp()
	app.Version = version
	app.ExtraInfo = func() map[string]string {
		return map[string]string{"Go version": goVersion}
	}
	app.Name = "hcf"
	app.Usage = "find CVEs for certain packages in harbor trivy reports"
	app.Commands = []*cli.Command{cmd.Analyze}
	app.HideHelpCommand = true

	app.Flags = parseGlobalFlags()
	app.Before = func(cliCtx *cli.Context) error {
		err := configureLogging(cliCtx)
		exitOnError(err)
		return nil
	}
	app.CustomAppHelpTemplate = createCustomAppHelpTemplate()

	err := app.Run(os.Args)
	exitOnError(err)
}

func parseGlobalFlags() []cli.Flag {
	return []cli.Flag{
		&cli.StringFlag{
			Name:  flagLogLevel,
			Usage: "a log level of lower than error will produce all kind of silly output",
			Value: "error",
		},
	}
}

func exitOnError(err error) {
	if err != nil {
		fmt.Printf("%s\n", err.Error())
		osExit.Exit(1)
	}
}

type anExit interface {
	Exit(exitCode int)
}

type realOsExit struct{}

func (ex *realOsExit) Exit(exitCode int) {
	os.Exit(exitCode)
}

func createCustomAppHelpTemplate() string {
	return `NAME:
   {{template "helpNameTemplate" .}}

USAGE:
   {{if .UsageText}}{{wrap .UsageText 3}}{{else}}{{.HelpName}} {{if .VisibleFlags}}[global options]{{end}}{{if .Commands}} command [command options]{{end}} {{if .ArgsUsage}}{{.ArgsUsage}}{{else}}{{if .Args}}[arguments...]{{end}}{{end}}{{end}}{{if .Version}}{{if not .HideVersion}}

VERSION:
   app version:	{{.Version}}{{range $key, $value := ExtraInfo}}
   {{$key}}:	{{$value}}{{end}}{{end}}{{end}}{{if .Description}}

DESCRIPTION:
   {{template "descriptionTemplate" .}}{{end}}
{{- if len .Authors}}

AUTHOR{{template "authorsTemplate" .}}{{end}}{{if .VisibleCommands}}

COMMANDS:{{template "visibleCommandCategoryTemplate" .}}{{end}}{{if .VisibleFlagCategories}}

GLOBAL OPTIONS:{{template "visibleFlagCategoryTemplate" .}}{{else if .VisibleFlags}}

GLOBAL OPTIONS:{{template "visibleFlagTemplate" .}}{{end}}{{if .Copyright}}

COPYRIGHT:
   {{template "copyrightTemplate" .}}{{end}}
`
}
